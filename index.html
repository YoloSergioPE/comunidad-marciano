<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Saluda al Marciano</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Segoe UI', Arial, sans-serif;
      background:
        linear-gradient(rgba(0,0,0,0.65), rgba(0,0,0,0.85)),
        url("assets/fondo.jpg") center / cover no-repeat fixed;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      padding: 20px;
    }

    .card {
      width: 100%;
      max-width: 420px;
      background: linear-gradient(
        180deg,
        rgba(255,255,255,0.08),
        rgba(255,255,255,0.02)
      );
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius: 18px;
      padding: 24px 20px 26px;
      border: 1px solid rgba(255,255,255,0.12);
      box-shadow:
        0 20px 40px rgba(0,0,0,0.55),
        inset 0 0 0 1px rgba(255,255,255,0.03);
      text-align: center;
    }

    .logo {
      width: 90px;
      margin: 0 auto 10px;
      border-radius: 18px;
    }

    h1 {
      font-size: 1.6rem;
      margin: 6px 0 4px;
    }

    .subtitle {
      font-size: 0.95rem;
      color: #cfd3ff;
      margin-bottom: 18px;
    }

    input, textarea {
      width: 100%;
      border-radius: 10px;
      border: none;
      padding: 12px 14px;
      margin-bottom: 10px;
      font-size: 0.95rem;
      background: rgba(255,255,255,0.95);
    }

    textarea {
      resize: none;
      min-height: 70px;
    }

    video, img.preview {
      width: 100%;
      border-radius: 14px;
      margin: 12px 0;
      background: #000;
    }

    button {
      width: 100%;
      padding: 13px;
      border-radius: 12px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      margin-top: 8px;
      background: linear-gradient(135deg, #1f8bff, #5f9dff);
      color: #fff;
      box-shadow: 0 8px 18px rgba(31,139,255,0.35);
    }

    button:disabled {
      background: #555;
      box-shadow: none;
      cursor: not-allowed;
    }

    .secondary {
      background: linear-gradient(135deg, #2b2b38, #3a3a4f);
    }

    #status {
      margin-top: 12px;
      font-size: 0.9rem;
      min-height: 18px;
      color: #aee0ff;
    }

    /* LOADING */
    #loadingScreen {
      position: fixed;
      inset: 0;
      background: linear-gradient(rgba(0,0,0,0.85), rgba(0,0,0,0.95));
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      text-align: center;
      padding: 20px;
    }

    .loading-box h2 {
      font-size: 1.4rem;
      margin-bottom: 10px;
    }

    .whatsapp-btn {
      display: inline-block;
      margin-top: 20px;
      padding: 12px 20px;
      border-radius: 12px;
      text-decoration: none;
      font-weight: 600;
      color: #fff;
      background: linear-gradient(135deg, #25D366, #1ebe5d);
    }

    #recordingIndicator {
      display: none;
      align-items: center;
      justify-content: center;
      margin: 12px 0;
      font-weight: 600;
      color: #ff5c5c;
    }


    .rec-dot {
      width: 12px;
      height: 12px;
      background: #ff3b3b;
      border-radius: 50%;
      margin-right: 8px;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.6); opacity: 0.6; }
      100% { transform: scale(1); opacity: 1; }
    }

  </style>
</head>

<body>

<!-- 
BLOQUE DE FOTO 
-->
  <div class="card" id="mainCard">
    <img src="assets/logo.png" class="logo" alt="El Marciano">
    <h1>Saluda al Marciano</h1>
    <p class="subtitle" id="subtitle">
      Elige c√≥mo quieres enviar tu saludo
    </p>


    <!-- SELECTOR -->
    <div id="modeSelector">
      <button onclick="selectMode('photo')">üì∏ Env√≠a tu foto</button>
      <button onclick="selectMode('audio')">üéôÔ∏è Env√≠a tu audio</button>
      <br>
      <hr>
      <br>
      <button onclick="selectMode('prediction')">üéØ Enviar predicci√≥n</button>
    </div>

    <!-- CONTENIDO FOTO -->
    <div id="photoContent" style="display:none;">
      <input id="name" placeholder="Tu nombre / de donde nos ves">
        <textarea id="message" placeholder="Tu mensaje para El Marciano"></textarea>

        <video id="video" autoplay playsinline></video>
        <img id="photoPreview" class="preview" style="display:none;" />

        <canvas id="canvas" style="display:none;"></canvas>
        <input 
          type="file" 
          id="galleryInput" 
          accept="image/*"
          style="display:none;"
        >
        <button class="secondary" onclick="switchCamera()" id="switchBtn">Cambiar c√°mara</button>
        <button onclick="takePhoto()" id="takeBtn">Tomar foto</button>
        <button class="secondary" onclick="openGallery()" id="galleryBtn">
          Subir desde galer√≠a
        </button>

        <button onclick="retakePhoto()" id="retakeBtn" style="display:none;">Hacer nueva foto</button>
        <button onclick="send()" id="sendBtn" style="display:none;">Enviar saludo</button>

        <div id="status"></div>
      </div>
      <!-- CONTENIDO AUDIO -->
    <div id="audioContent" style="display:none;">
          <input id="audioName" placeholder="Tu nombre / de donde nos ves">

          <input 
            type="file"
            id="iosAudioInput"
            accept="audio/*"
            capture
            style="display:none;"
          >

          <button onclick="startRecording()">üéôÔ∏è Grabar audio</button>
          <button onclick="stopRecording()" disabled id="stopBtn">‚èπÔ∏è Detener</button>

          <audio id="audioPreview" controls style="display:none;"></audio>

          <button onclick="sendAudio()" id="sendAudioBtn" style="display:none;">
            Enviar audio
          </button>
          <div id="recordingIndicator" style="display:none;">
            <div class="rec-dot"></div>
            <span>Grabando audio...</span>
          </div>
          <div id="audioStatus"></div>
    </div>
    <!-- PREDICCION -->
      <div id="predictionContent" style="display:none;">

      <input id="predName" placeholder="Nombre completo">
      <input id="predPhone" placeholder="N√∫mero celular">

      <div style="margin:12px 0;">
        <b>Selecciona tu ganador</b>
        <div>
          <label><input type="radio" name="winner" value="team1"> <span id="team1Label">Equipo 1</span></label><br>
          <label><input type="radio" name="winner" value="team2"> <span id="team2Label">Equipo 2</span></label>
        </div>
      </div>

      <input type="file" id="predImage" accept="image/*">

      <button onclick="sendPrediction()" id="sendPredBtn" disabled>
        Enviar predicci√≥n
      </button>

      <div id="predStatus"></div>

    </div>
  </div>

<!-- LOADING GLOBAL -->
<div id="loadingScreen">
  <div class="loading-box">
    <h2 id="loadingText"></h2>

    <div id="loadingActions" style="display:none;">
      <button class="secondary" onclick="resetApp()">
        Volver al inicio
      </button>
    </div>
  </div>
</div>


<script>
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const preview = document.getElementById("photoPreview");
  const statusText = document.getElementById("status");

  const takeBtn = document.getElementById("takeBtn");
  const retakeBtn = document.getElementById("retakeBtn");
  const sendBtn = document.getElementById("sendBtn");
  const switchBtn = document.getElementById("switchBtn");
  const sendAudioBtn = document.getElementById("sendAudioBtn");

  const loadingScreen = document.getElementById("loadingScreen");
  const loadingText = document.getElementById("loadingText");
  const mainCard = document.getElementById("mainCard");
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

  const team1Label = document.getElementById("team1Label");
  const team2Label = document.getElementById("team2Label");

  document.getElementById("sendPredBtn").disabled = true;
  document.getElementById("sendPredBtn").innerText = "Cargando partida...";



  let imageData = null;
  let currentFacing = "user";
  let stream = null;
  let predictionImage = null;


  function startCamera() {
    if (stream) stream.getTracks().forEach(t => t.stop());

    navigator.mediaDevices.getUserMedia({
      video: { facingMode: currentFacing, width:{ideal:1280}, height:{ideal:720} }
    }).then(s => {
      stream = s;
      video.srcObject = stream;
    });
  }

  function switchCamera() {
    currentFacing = currentFacing === "user" ? "environment" : "user";
    startCamera();
  }

  function takePhoto() {
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video, 0, 0);

    imageData = canvas.toDataURL("image/jpeg", 0.9).split(",")[1];
    preview.src = "data:image/jpeg;base64," + imageData;

    video.style.display = "none";
    preview.style.display = "block";

    takeBtn.style.display = "none";
    switchBtn.style.display = "none";
    retakeBtn.style.display = "block";
    sendBtn.style.display = "block";
    sendBtn.disabled = false;



    statusText.innerText = "¬øTe gusta la foto?";    
  }

  function retakePhoto() {
    imageData = null;

    preview.style.display = "none";
    video.style.display = "block";

    takeBtn.style.display = "block";
    switchBtn.style.display = "block";
    document.getElementById("galleryBtn").style.display = "block";

    retakeBtn.style.display = "none";
    sendBtn.style.display = "none";

    galleryInput.value = "";
    statusText.innerText = "";
    sendBtn.disabled = false;

  }


  function send() {
    mainCard.style.display = "none";
    loadingScreen.style.display = "flex";
    
    loadingText.innerText = "Tu saludo se est√° enviando, Marcianin üëΩ";
    document.getElementById("loadingActions").style.display = "none";

    sendBtn && (sendBtn.disabled = true);
    document.getElementById("sendAudioBtn")?.setAttribute("disabled", true);

    fetch("https://script.google.com/macros/s/AKfycbxSqyOZkZ5K6JB0r15bC5qwn6TXc-mB1lOG2kC3j8DSnTf1z379di76JP2qJj-uoFAolA/exec", {
      method: "POST",
      headers:{ "Content-Type":"text/plain;charset=utf-8" },
      body: JSON.stringify({
        type: "photo",
        name: document.getElementById("name").value || "Anonimo",
        message: document.getElementById("message").value || "",
        image: imageData
      })
    }).then(() => {
      loadingText.innerHTML = `
        Tus saludos han sido enviados mi marcianin üëΩ<br><br>
        <a class="whatsapp-btn" target="_blank"
           href="https://chat.whatsapp.com/IviDOt7pRjbCywAfzSFe6d">
           Unirme a la comunidad üöÄ
        </a>
      `;
      document.getElementById("loadingActions").style.display = "block";
    });
  }

  const galleryInput = document.getElementById("galleryInput");
  const galleryBtn = document.getElementById("galleryBtn");

  function openGallery() {
    galleryInput.click();
  }

  galleryInput.addEventListener("change", () => {
    const file = galleryInput.files[0];
    if (!file) return;

    if (!file.type.startsWith("image/")) {
      alert("Solo se permiten im√°genes");
      return;
    }

    const reader = new FileReader();
    reader.onload = () => {
      const base64 = reader.result.split(",")[1];
      imageData = base64;

      preview.src = reader.result;

      video.style.display = "none";
      preview.style.display = "block";

      takeBtn.style.display = "none";
      switchBtn.style.display = "none";
      galleryBtn.style.display = "none";

      retakeBtn.style.display = "block";
      sendBtn.style.display = "block";
      sendBtn.disabled = false; // ‚úÖ FIX

      statusText.innerText = "Imagen cargada desde tu galer√≠a üì∏";
    };

    reader.readAsDataURL(file);
  });

  function selectMode(mode) {
      document.getElementById("predictionContent").style.display = "none";
      document.getElementById("modeSelector").style.display = "none";
      document.getElementById("photoContent").style.display = "none";
      document.getElementById("audioContent").style.display = "none";

    if (mode === "photo") {
      document.getElementById("photoContent").style.display = "block";
      startCamera(); // permisos SOLO aqu√≠
    }

    if (mode === "audio") {
      audioBlob = null;
      sendAudioBtn.disabled = false;
      sendAudioBtn.style.display = "none";

      document.getElementById("audioContent").style.display = "block";
      startAudio(); // permisos SOLO aqu√≠
    }
    if (mode === "prediction") {
      document.getElementById("predictionContent").style.display = "block";
    }

  }

    let mediaRecorder;
    let audioChunks = [];
    let audioBlob = null;
    let audioStream = null;

    function startAudio() {
      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(s => {
          audioStream = s;

          let options = {};
          if (MediaRecorder.isTypeSupported("audio/webm"))
            options.mimeType = "audio/webm";
          else if (MediaRecorder.isTypeSupported("audio/mp4"))
            options.mimeType = "audio/mp4";

          try{
            mediaRecorder = new MediaRecorder(s, options);
          }catch{
            // fallback iOS
            mediaRecorder = null;
          }
        });
    }


    const iosAudioInput = document.getElementById("iosAudioInput");

    iosAudioInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;

      audioBlob = file;

      const audioURL = URL.createObjectURL(file);
      const audioPreview = document.getElementById("audioPreview");

      audioPreview.src = audioURL;
      audioPreview.style.display = "block";
      sendAudioBtn.disabled = false;
      document.getElementById("sendAudioBtn").style.display = "block";
    });

    function startRecording() {
      if (isIOS) {
        iosAudioInput.click();
        return;
      }

      if (!mediaRecorder) return;

      audioChunks = [];
      mediaRecorder.start();

      document.getElementById("recordingIndicator").style.display = "flex";
      document.getElementById("stopBtn").disabled = false;
    }


    function stopRecording() {
      mediaRecorder.stop();

      document.getElementById("recordingIndicator").style.display = "none";
      document.getElementById("stopBtn").disabled = true;

      mediaRecorder.ondataavailable = e => {
        audioChunks.push(e.data);
      };

      mediaRecorder.onstop = () => {
        const mimeType = MediaRecorder.isTypeSupported("audio/webm")
          ? "audio/webm"
          : "audio/mp4";

        audioBlob = new Blob(audioChunks, { type: mimeType });


        const audioURL = URL.createObjectURL(audioBlob);
        const audioPreview = document.getElementById("audioPreview");

        audioPreview.src = audioURL;
        audioPreview.style.display = "block";
        sendAudioBtn.disabled = false;

        document.getElementById("sendAudioBtn").style.display = "block";
      };
    }

    function sendAudio() {
      mainCard.style.display = "none";
      loadingScreen.style.display = "flex";
      
      loadingText.innerText = "Tu saludo se est√° enviando, Marcianin üëΩ";
      document.getElementById("loadingActions").style.display = "none";


      const reader = new FileReader();

      reader.onload = () => {
        const base64Audio = reader.result.split(",")[1];

        sendBtn && (sendBtn.disabled = true);
        document.getElementById("sendAudioBtn")?.setAttribute("disabled", true);

        fetch("https://script.google.com/macros/s/AKfycbxSqyOZkZ5K6JB0r15bC5qwn6TXc-mB1lOG2kC3j8DSnTf1z379di76JP2qJj-uoFAolA/exec", {
          method: "POST",
          headers:{ "Content-Type":"text/plain;charset=utf-8" },
          body: JSON.stringify({
            type: "audio",
            name: document.getElementById("audioName").value || "Anonimo",
            audio: base64Audio
          })
        }).then(() => {
          loadingText.innerHTML = `
            Tus saludos han sido enviados mi marcianin üëΩ<br><br>
            <a class="whatsapp-btn" target="_blank"
              href="https://chat.whatsapp.com/IviDOt7pRjbCywAfzSFe6d">
              Unirme a la comunidad üöÄ
            </a>
          `;
          document.getElementById("loadingActions").style.display = "block";
        });
      };

      reader.readAsDataURL(audioBlob);
    }

    document.getElementById("predImage").addEventListener("change", e=>{
      const file = e.target.files[0];
      if(!file) return;

      const reader = new FileReader();
      reader.onload = ()=>{
        predictionImage = reader.result.split(",")[1];
        updatePredictionButton();
      };
      reader.readAsDataURL(file);
    });


    document.getElementById("predName").addEventListener("input", updatePredictionButton);
    document.getElementById("predPhone").addEventListener("input", updatePredictionButton);
    document.querySelectorAll('input[name="winner"]').forEach(r=>{
      r.addEventListener("change", updatePredictionButton);
    });


    function updatePredictionButton(){
      const name = document.getElementById("predName").value.trim();
      const phone = document.getElementById("predPhone").value.trim();
      const winner = document.querySelector('input[name="winner"]:checked');

      const valid =
        predictionsOpen &&
        predictionImage &&
        name.length > 0 &&
        phone.length > 0 &&
        winner;

      document.getElementById("sendPredBtn").disabled = !valid;
    }


    function sendPrediction(){

      if(!predictionsOpen){
        alert("Las predicciones ya fueron cerradas üëΩ");
        return;
      }

      const name = document.getElementById("predName").value;
      const phone = document.getElementById("predPhone").value;
      const winner = document.querySelector('input[name="winner"]:checked');

      if(!winner){
        alert("Selecciona un equipo");
        return;
      }
      if(!name || !phone || !predictionImage){
        alert("Completa todos los campos");
        return;
      }

      mainCard.style.display = "none";
      loadingScreen.style.display = "flex";
      loadingText.innerText = "Registrando tu predicci√≥n üëΩ";

      fetch("https://script.google.com/macros/s/AKfycbxSqyOZkZ5K6JB0r15bC5qwn6TXc-mB1lOG2kC3j8DSnTf1z379di76JP2qJj-uoFAolA/exec",{
        method:"POST",
        headers:{ "Content-Type":"text/plain;charset=utf-8" },
        body:JSON.stringify({
          type:"prediction",
          name:name,
          phone:phone,
          team:winner.value === "team1" ? team1Label.innerText : team2Label.innerText,
          rival:winner.value === "team1" ? team2Label.innerText : team1Label.innerText,
          image:predictionImage
        })
      }).then(()=>{
          loadingText.innerHTML = `
            Tu predicci√≥n ha sido enviada mi marcianin üëΩ<br><br>
            <a class="whatsapp-btn" target="_blank"
              href="https://chat.whatsapp.com/IviDOt7pRjbCywAfzSFe6d">
              Unirme a la comunidad üöÄ
            </a>
          `;
          document.getElementById("loadingActions").style.display = "block";
        });
    }



    function resetApp() {
      loadingScreen.style.display = "none";
      mainCard.style.display = "block";
      iosAudioInput.value = "";

      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }

      if (audioStream) {
        audioStream.getTracks().forEach(t => t.stop());
        audioStream = null;
      }


      document.getElementById("modeSelector").style.display = "block";
      document.getElementById("photoContent").style.display = "none";
      document.getElementById("audioContent").style.display = "none";

      document.getElementById("photoPreview").style.display = "none";
      document.getElementById("audioPreview").style.display = "none";
      document.getElementById("sendAudioBtn").style.display = "none";

      document.getElementById("recordingIndicator").style.display = "none";
      document.getElementById("stopBtn").disabled = true;

      imageData = null;
      audioBlob = null;
      sendBtn.disabled = false;
      sendAudioBtn.disabled = false;
      sendAudioBtn.style.display = "none";

      predictionImage = null;
      document.getElementById("predImage").value = "";
      document.querySelectorAll('input[name="winner"]').forEach(r=>r.checked=false);
      document.getElementById("sendPredBtn").disabled = true;
      document.getElementById("predictionContent").style.display = "none";


      document.getElementById("name").value = "";
      document.getElementById("message").value = "";
      document.getElementById("audioName").value = "";

      document.getElementById("predStatus").innerText = "";
      document.getElementById("status").innerText = "";
      window.scrollTo(0,0);
      updatePredictionButton();


      document.getElementById("subtitle").innerText =
        "Elige c√≥mo quieres enviar tu saludo";
    }

    /* ===================== PREDICCIONES ENGINE ===================== */

    const API_URL = "https://script.google.com/macros/s/AKfycbxSqyOZkZ5K6JB0r15bC5qwn6TXc-mB1lOG2kC3j8DSnTf1z379di76JP2qJj-uoFAolA/exec";

    let lastMatchId = null;
    let lastStateHash = null;
    let predictionsOpen = false;

    async function updateMatchState() {
      try {
        const res = await fetch(API_URL + "?t=" + Date.now());

        if (!res.ok) return;

        const text = await res.text();

        let data;
        try { data = JSON.parse(text); }
        catch { return; }

        const stateHash = JSON.stringify(data);
        if (stateHash === lastStateHash) return;
        lastStateHash = stateHash;

        team1Label.innerText = `${data.team1} (${data.score1})`;
        team2Label.innerText = `${data.team2} (${data.score2})`;

        predictionsOpen = data.open === true;

        const btn = document.getElementById("sendPredBtn");

        if (predictionsOpen) {
          btn.innerText = "Enviar predicci√≥n";
          btn.style.background = "";
          updatePredictionButton();
        } else {
          btn.disabled = true;
          btn.innerText = "Predicciones cerradas";
          btn.style.background = "#444";
        }

        if (lastMatchId && lastMatchId !== data.match_id) {
          resetPredictionForm();
        }

        lastMatchId = data.match_id;

      } catch {}
    }

    function resetPredictionForm() {
      document.getElementById("predName").value = "";
      document.getElementById("predPhone").value = "";
      document.getElementById("predImage").value = "";
      predictionImage = null;

      document.querySelectorAll('input[name="winner"]').forEach(r=>r.checked=false);
      document.getElementById("sendPredBtn").disabled = true;
    }

    updateMatchState();
    setInterval(updateMatchState, 45000 + Math.random()*15000);


</script>

</body>
</html>
